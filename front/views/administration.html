<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Formularios</title>

    <!-- Hoja de estilos general -->
    <!-- <link rel="stylesheet" href="../static/css/style.css"> -->

    <link rel="stylesheet" href="../static/css/styles.css">


    <!-- Hoja de estilos específica para la modal -->
    <link rel="stylesheet" href="../static/css/stylemodal.css">

</head>

<body>
    <!-- Título -->
    <h1>Administración de Información Sobre el Tiquete Estudiantil</h1>

    <!-- Identificador de la tabla -->
    <table id="formDataTable">
        <thead>
            <tr>
                <th>NOMBRES</th>
                <th>APELLIDO 1</th>
                <th>APELLIDO 2</th>
                <th>TIPO DE DOCUMENTO</th>
                <th>NRO DE DOCUMENTO</th>
                <th>DIRECCIÓN</th>
                <th>FECHA DE NACIMIENTO</th>
                <th>EDAD</th>
                <th>BARRIO</th>
                <th>ESTRATO</th>
                <th>TELÉFONO</th>
                <th>CORREO</th>
                <th>PROGRAMA</th>
                <th>SEMESTRE</th>
                <th>DESCARGAR DOCUMENTOS</th>
                <th>EDITAR INFORMACIÓN</th>
            </tr>
        </thead>
        <tbody>
            <!-- Aquí se insertarán los datos del formulario -->
        </tbody>
    </table>

    <!-- Modal para edición -->
    <div id="editModal">
        <div id="modalContent">
            <span class="close" id="closeModal">&times;</span>
            <h2>Editar Información</h2>
            <form id="editForm">
                <label for="NombreCompleto">Nombre Completo:</label>
                <input type="text" id="NombreCompleto" name="NombreCompleto" required />
                <label for="Apellido1">Apellido 1:</label>
                <input type="text" id="Apellido1" name="Apellido1" />
                <label for="Apellido2">Apellido 2:</label>
                <input type="text" id="Apellido2" name="Apellido2" required />
                <label for="TipoDocumento">Tipo de Documento:</label>
                <select id="TipoDocumento" name="TipoDocumento" required>
                    <option value="">Selecciona una opción:</option>
                    <option value="C.C.">CÉDULA DE CIUDADANÍA</option>
                    <option value="T.I.">TARJETA DE IDENTIDAD</option>
                    <option value="C.E.">CÉDULA DE EXTRANJERÍA</option>
                </select>
                <label for="nroDocumento">Numero documento:</label>
                <input type="text" id="nroDocumento" name="nro_documento" required />
                <label for="Direccion">Dirección:</label>
                <input type="text" id="Direccion" name="Direccion" required />
                <label for="FechaNacimiento">Fecha de Nacimiento:</label>
                <input type="date" id="FechaNacimiento" name="FechaNacimiento" required />
                <label for="Edad">Edad:</label>
                <input type="number" id="Edad" name="Edad" readonly />
                <label for="Barrio">Barrio:</label>
                <input type="text" id="Barrio" name="Barrio" required />
                <label for="Estrato">Estrato:</label>
                <input type="number" id="Estrato" name="Estrato" min="1" max="6" required />
                <label for="Telefono">Teléfono:</label>
                <input type="text" id="Telefono" name="Telefono" required maxlength="10" />
                <label for="Correo">Correo:</label>
                <input type="email" id="Correo" name="Correo" required />
                <label for="Programa">Programa:</label>
                <input type="text" id="Programa" name="Programa" required />
                <label for="Semestre">Semestre:</label>
                <input type="number" id="Semestre" name="Semestre" required  />
                <button type="submit" id="saveButton">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <script>
        // URL de la API para obtener los datos
        const apiUrl = "http://localhost:8000/datos/";

        // Función para cargar los datos y rellenar la tabla
        async function cargarDatos() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error("Error al obtener los datos del servidor");
                }

                const formData = await response.json(); // Obtener los datos en formato JSON
                const tableBody = document.querySelector('#formDataTable tbody'); // Obtener el cuerpo de la tabla

                // Limpiar cualquier dato previo en la tabla
                tableBody.innerHTML = "";

                // Rellenar la tabla con los datos obtenidos
                formData.forEach(data => {
                    const row = document.createElement('tr');

                    // Crear una celda por cada campo de datos
                    Object.keys(data).forEach(key => {
                        const cell = document.createElement('td');
                        cell.textContent = data[key] !== null ? data[key] : ""; // Manejar valores nulos
                        row.appendChild(cell);
                    });

                    // Crear la celda de botones de descarga
                    const downloadCell = document.createElement('td');
                    const downloadButton = document.createElement('button');
                    downloadButton.textContent = "Descargar Archivos";
                    downloadButton.classList.add("btn", "download-btn");


                    downloadButton.addEventListener('click', () => descargarArchivos(data.NroDocumento));
                    downloadCell.appendChild(downloadButton);
                    row.appendChild(downloadCell);

                    // Crear la celda de edición
                    const editCell = document.createElement('td');
                    const editButton = document.createElement('button');
                    editButton.classList.add("btn", "edit-btn");
                    editButton.textContent = "Editar";
                    editButton.addEventListener('click', () => editarDatos(data));
                    editCell.appendChild(editButton);
                    row.appendChild(editCell);

                    // Agregar la fila a la tabla
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error("Error:", error);
            }
        }

        // Función para descargar los archivos de un usuario específico
        function descargarArchivos(nroDocumento) {
            const downloadUrl = `http://localhost:8000/descargar/${nroDocumento}`;
            window.open(downloadUrl, "_blank");
        }

        // Función para llenar el formulario de edición con los datos del usuario
        function editarDatos(data) {
            // Mostrar el modal
            document.getElementById('editModal').style.display = 'block';

            // Convertir la fecha al formato compatible con el input de tipo date (YYYY-MM-DD)
            const fechaNacimientoFormateada = data.FechaNacimiento.split('-').reverse().join('-');

            // Rellenar los campos del formulario con los datos
            document.getElementById('nroDocumento').value = data.NroDocumento;
            document.getElementById('NombreCompleto').value = data.NombreCompleto;
            document.getElementById('Apellido1').value = data.Apellido1;
            document.getElementById('Apellido2').value = data.Apellido2;
            document.getElementById('TipoDocumento').value = data.TipoDocumento;
            document.getElementById('Direccion').value = data.Direccion;
            document.getElementById('FechaNacimiento').value = fechaNacimientoFormateada;
            document.getElementById('Edad').value = data.Edad;
            document.getElementById('Barrio').value = data.Barrio;
            document.getElementById('Estrato').value = data.Estrato;
            document.getElementById('Telefono').value = data.Telefono;
            document.getElementById('Correo').value = data.Correo;
            document.getElementById('Programa').value = data.Programa;
            document.getElementById('Semestre').value = data.Semestre;
        }

        // Cerrar el modal
        document.getElementById('closeModal').onclick = function () {
            document.getElementById('editModal').style.display = 'none';
        };

        // Función para enviar los cambios al backend
        document.getElementById('editForm').onsubmit = async function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            const response = await fetch(`http://localhost:8000/editar/${formData.get('nro_documento')}`, {
                method: 'PUT',
                body: formData
            });

            if (response.ok) {
                alert('Datos actualizados correctamente');
                cargarDatos(); // Recargar los datos después de la actualización
                document.getElementById('editModal').style.display = 'none'; // Cerrar el modal
            } else {
                alert('Hubo un error al actualizar los datos');
            }
        };

        // Función para descargar los archivos de un usuario específico
        function descargarArchivos(nroDocumento) {
            const downloadUrl = `http://localhost:8000/descargar/${nroDocumento}`;
            window.open(downloadUrl, "_blank");
        }


        // Cargar los datos al iniciar la página
        window.onload = cargarDatos;

        // Llamar a la función para cargar los datos cuando la página se cargue
        document.addEventListener("DOMContentLoaded", cargarDatos);


        //validacion de numero documento, para que solo permita letras en cedula de extrangeria
        document.addEventListener("DOMContentLoaded", () => {
            const tipoDocumento = document.getElementById("TipoDocumento");
            const nroDocumento = document.getElementById("nroDocumento"); // Corregido: debe coincidir con el ID en el HTML

            // Validar en tiempo real el contenido del campo Número de Documento
            nroDocumento.addEventListener("input", () => {
                const tipo = tipoDocumento.value; // Obtener el valor actual del tipo de documento

                if (tipo === "C.C." || tipo === "T.I.") {
                    // Solo permitir números
                    nroDocumento.value = nroDocumento.value.replace(/[^0-9]/g, "");
                } else if (tipo === "C.E.") {
                    // Permitir letras y números
                    nroDocumento.value = nroDocumento.value.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
                } else {
                    // Vaciar el campo si no se selecciona un tipo válido
                    nroDocumento.value = "";
                }
            });

            // Agregar un evento al cambio de tipo de documento para limpiar el campo si es necesario
            tipoDocumento.addEventListener("change", () => {
                const tipo = tipoDocumento.value;

                // Si cambia el tipo de documento, limpiar el campo para evitar valores no válidos
                if (tipo !== "C.E.") {
                    nroDocumento.value = nroDocumento.value.replace(/[^0-9]/g, ""); // Solo números
                }
            });
        });

    </script>


    <!-- Botón para descargar el archivo Excel -->
    <div class="form-group">
        <a href="/descargar-excel" download>
            <button type="button" id="download" class="btn-descargar-excel">Descargar Archivo Excel</button>
        </a>
    </div>
    <script src="../static/javascript/editValidator.js"></script>
</body>

</html>